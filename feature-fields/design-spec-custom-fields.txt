================================================================================
KNOTEBOOK - CUSTOM FIELDS DESIGN SPECIFICATION
================================================================================
Created: 2026-01-30
Updated: 2026-02-10 (Session 2)
Status: Phase 3 Complete - Editor integration with dropdowns (see IMPLEMENTATION STATUS below)
Related: design-spec.txt (current), design-spec-future.txt (planned architecture)

================================================================================
IMPLEMENTATION STATUS
================================================================================

**COMPLETED:**
- [x] Phase 0: Unified field storage (node.fields.{fieldName}) - v168
- [x] Phase 1: Priority field (First Class) - v166
- [x] Phase 1b: Generalized First Class Fields architecture - v167
- [x] Phase 1c: Generalized field infrastructure for Second Class - v169-170
- [x] Settings UI for First Class field defaults - v171
- [x] Phase 2: Custom Fields (Second Class) Settings UI - v172-177
  - Tabbed settings modal (General | Custom Fields)
  - Add/Edit/Delete custom fields
  - Field editor modal with dropdown type selector
  - Field cards showing name, type, options
- [x] Phase 3: Editor integration for custom fields - v173-179
  - Generalized field renderer registry pattern
  - Single-select fields: HTML dropdown
  - Multi-select fields: Dropdown with checkboxes
  - Batch mode support (unanimous values shown)
  - "(add new...)" option in dropdowns to expand options on-the-fly
  - Load/save from node.fields
  - Auto-render based on projectSettings.customFields

**COMPLETED:**
- [x] Phase 4: Export/Import with custom fields - v180
  - Merge strategy for field definitions
  - Conflict resolution modal (batch "Keep All" / "Use All" buttons)
  - Backwards compatible with old exports

**NOT STARTED:**
- [ ] Phase 5: Fields Sidebar
- [ ] Phase 6: Hashtag Migration Tool
- [ ] Future: Text/number/date/checkbox/url field types
- [ ] Future: Required fields, default values, advanced filtering, list view

================================================================================
OVERVIEW
================================================================================

Custom fields transform knotebook from a simple note-taking app into a flexible
knowledge/project management tool. Fields provide structured data alongside
free-form note content, enabling filtering, sorting, and organization beyond
hashtags alone.

**Core Concept:**
A two-tier field system balancing consistency with flexibility:
1. **First Class Fields:** Global, hard-coded, with special visual treatment
2. **Second Class Fields:** Per-notebook, user-defined, generic handling

================================================================================
PROBLEM STATEMENT
================================================================================

**Current Limitations with Hashtag-Only Organization:**

1. **Tag Pollution**
   - Using hashtags for structured data: #effort-low, #priority-urgent
   - Creates many single-purpose tags
   - Clutters hashtag sidebar with metadata

2. **No Constraints**
   - Typos create duplicates: #effort-low vs #effortlow vs #effort_low
   - Can't enforce single-choice (could have #effort-low AND #effort-high)
   - No validation or consistency

3. **Poor UX**
   - Typing is slower than dropdown selection
   - Hard to remember exact tag names
   - Difficult to change values (find/replace across notes)

4. **Limited Querying**
   - Can't easily find "all notes with effort=medium AND priority=high"
   - Hashtag filter uses OR logic only
   - No field-specific filtering

5. **No Structure**
   - Can't enforce data types (dates, numbers, booleans)
   - Can't provide defaults
   - Can't mark fields as required


================================================================================
TWO-TIER FIELD SYSTEM
================================================================================

## First Class Fields (Global, Special Behavior)

**Definition:**
Fields that are hard-coded into the application with explicit logic and special
visual treatment. Available to all notebooks automatically.

**Characteristics:**
- **Global scope:** Available in every notebook
- **Explicit code:** Each field has dedicated rendering/interaction logic
- **Front-of-card representation:** Can display on node canvas (not just editor)
- **Special interactions:** May be clickable, color-coded, or have custom UI
- **Consistent behavior:** Work the same way in all notebooks

**Examples:**

1. **Completion** (IMPLEMENTED)
   - Type: single-select
   - Options: null, 'no', 'partial', 'yes', 'cancelled'
   - Display: Checkmark icons (â—‹ â— âœ“ âœ•)
   - Location: Top-right of node
   - Interaction: Click on node to cycle states
   - Visual: Grayscale filter on completed notes

2. **Priority** (IMPLEMENTED - v166)
   - Type: single-select
   - Options: null, 'low', 'medium', 'high'
   - Display: Arrow icons (â–¼ â–¬ â–²) with colored background
   - Location: Bottom-right of node
   - Color coding:
     * High: Red (#ef4444)
     * Medium: Yellow (#eab308)
     * Low: Blue (#3b82f6)
     * None: No indicator
   - Interaction: Click on node to cycle states (like completion)

**Future Candidates:**
- **Flagged:** boolean, star icon, click to toggle
- **Assignee:** text/select, avatar/initials on node
- **Due Date:** date, shows countdown/overdue indicator
- **Archived:** boolean, dims/hides node

**Decision Criteria for First Class Fields:**
A field should be First Class if it meets TWO OR MORE of these criteria:
- Needed across most/all use cases (broadly applicable)
- Benefits from front-of-card visual representation
- Requires special interaction logic (click to toggle, color coding)
- Affects node rendering/layout (grayscale, positioning, size)
- Core to task/project management workflows

---

## Second Class Fields (Per-Notebook, User-Defined)

**Definition:**
Fields defined by users on a per-notebook basis with generic handling. Created
on-the-fly as needed for specific contexts.

**Characteristics:**
- **Notebook scope:** Each notebook defines its own field schema
- **User-defined:** Created/edited/deleted via settings UI
- **Generic handling:** All fields use same rendering code
- **No front-of-card representation:** Only visible in editor/sidebar/list view
- **Context-dependent:** Fields make sense for specific use cases

**Field Types:**

1. **Single-select** (dropdown)
   - User defines options list
   - Enforces single choice
   - Example: effort [low, medium, high]

2. **Multi-select** (checkboxes)
   - User defines options list
   - Allows multiple selections
   - Example: technologies [React, Node, Python, Go]

3. **Text** (short input)
   - Free-form text entry
   - Optional max length
   - Example: author, assignee, source

4. **Number** (numeric input)
   - Integer or decimal
   - Optional min/max range
   - Example: rating (1-5), hours, score

5. **Date** (date picker)
   - Date selection UI
   - Stores ISO format (YYYY-MM-DD)
   - Example: date-read, start-date, deadline

6. **Checkbox** (boolean)
   - True/false toggle
   - Example: read, verified, archived

7. **URL** (link input)
   - Validated URL format
   - Optional: click to open
   - Example: source-link, repository

**Examples by Use Case:**

**Book Collection Notebook:**
- author (text)
- date-read (date)
- genre (single-select: fiction, non-fiction, biography, etc.)
- rating (number: 1-5)
- publisher (text)
- owned (checkbox)

**Project Management Notebook:**
- effort (single-select: low, medium, high)
- sprint (single-select: sprint-1, sprint-2, etc.)
- team-owner (single-select: frontend, backend, design, etc.)
- blocked (checkbox)
- dependencies (text: comma-separated note IDs)

**Research Notes Notebook:**
- source (text)
- methodology (single-select: qualitative, quantitative, mixed)
- confidence (single-select: low, medium, high)
- year (number)
- peer-reviewed (checkbox)
- doi (url)

================================================================================
DATA MODEL
================================================================================

## First Class Fields (Hard-Coded)

```javascript
// Global constant in app.js
const FIRST_CLASS_FIELDS = {
  completion: {
    type: 'single-select',
    label: 'Status',
    options: [
      { value: null, label: 'None' },
      { value: 'no', label: 'To do', icon: 'â—‹' },
      { value: 'yes', label: 'Done', icon: 'âœ“' },
      { value: 'partial', label: 'Partial', icon: 'â—' }
    ],
    default: null,
    onNodeRender: true,      // Shows on node canvas
    clickable: true,         // Can cycle on node click
    position: 'top-right'    // Node position
  },

  priority: {
    type: 'single-select',
    label: 'Priority',
    options: [
      { value: null, label: 'None' },
      { value: 'low', label: 'Low', color: '#3b82f6' },
      { value: 'normal', label: 'Normal', color: '#eab308' },
      { value: 'high', label: 'High', color: '#f97316' },
      { value: 'urgent', label: 'Urgent', color: '#ef4444' }
    ],
    default: null,
    onNodeRender: true,      // Shows as colored dot
    clickable: false,        // Set via editor only
    position: 'top-left'     // Node position
  }
};
```

---

## Second Class Fields (Per-Notebook)

```javascript
// IMPLEMENTED (v169-171) - Stored in notebook settings
projectSettings: {
  fieldDefaults: {           // Default values for First-Class fields
    completion: null,        // e.g., 'no' for "To do" by default
    priority: null           // e.g., 'medium' for "Medium" by default
  },
  customFields: [            // Second-Class field definitions
    {
      id: 'field-1',         // Unique ID for field definition
      name: 'effort',        // Internal name (no spaces)
      label: 'Effort',       // Display name
      type: 'single-select', // Field type
      options: ['low', 'medium', 'high'],  // Predefined options
      allowNew: true         // Allow adding new values (hybrid mode)
    },
    {
      id: 'field-2',
      name: 'author',
      label: 'Author',
      type: 'text',
      maxLength: 100
    },
    {
      id: 'field-3',
      name: 'technologies',
      label: 'Technologies',
      type: 'multi-select',  // Multiple values can be selected
      options: ['React', 'Node', 'Python']
    },
    {
      id: 'field-4',
      name: 'dateRead',
      label: 'Date Read',
      type: 'date'
    },
    {
      id: 'field-5',
      name: 'rating',
      label: 'Rating',
      type: 'number',
      min: 1,
      max: 5
    },
    {
      id: 'field-6',
      name: 'verified',
      label: 'Verified',
      type: 'checkbox'
    }
  ]
}

// Supported field types:
// - single-select: Button group, one active (like completion/priority)
// - multi-select: Button group, multiple active
// - text: Text input
// - number: Number input with optional min/max
// - date: Date picker
// - checkbox: Boolean toggle
```
```

---

## Note Instance

```javascript
// IMPLEMENTED (v168) - Unified field storage
{
  id: "note-123",
  title: "The Phoenix Project",
  content: "Great book about DevOps and IT management...",
  hashtags: ["#business", "#devops"],
  position: { x: 100, y: 200 },
  created: "2026-01-15T10:00:00Z",
  modified: "2026-01-30T14:30:00Z",

  // ALL fields stored in unified location (First-Class AND Second-Class)
  fields: {
    completion: "yes",              // First-Class: âœ“ Done
    priority: "high",               // First-Class: â–² High priority
    effort: "medium",               // Second-Class: custom field
    author: "Gene Kim",             // Second-Class: custom field
    technologies: ["Node", "React"],// Second-Class: multi-select
    rating: 5                       // Second-Class: custom field
  },

  // LEGACY (auto-migrated on load):
  // completion: "yes",   // Migrated to fields.completion
  // priority: "high",    // Migrated to fields.priority
  // customFields: {...}  // Would be merged into fields.{}
    effort: "medium",
    author: "Gene Kim",
    dateRead: "2026-01-15",
    rating: 5
  }
}
```

**Notes:**
- First Class Fields stored as top-level properties (backwards compatible)
- Second Class Fields in `customFields` object (keyed by field name)
- Missing fields = undefined (not stored, saves space)
- Field definitions in notebook settings, values in note instances

================================================================================
USER INTERFACE
================================================================================

## Settings Modal - Custom Fields Tab

**New tab in settings modal (alongside General):**

```
â”Œâ”€ Notebook Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [General] [Custom Fields]                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚ Custom Fields                                              â”‚
â”‚                                                            â”‚
â”‚ Define fields for notes in this notebook. Fields appear   â”‚
â”‚ in the note editor and can be used for filtering.         â”‚
â”‚                                                            â”‚
â”‚ [+ Add Field]                                              â”‚
â”‚                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Field: effort                                  [Edit]  â”‚â”‚
â”‚ â”‚ Type: Single-select                          [Delete] â”‚â”‚
â”‚ â”‚ Options: low, medium, high                             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Field: author                                  [Edit]  â”‚â”‚
â”‚ â”‚ Type: Text                                   [Delete] â”‚â”‚
â”‚ â”‚ Max length: 100                                        â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Field: dateRead                                [Edit]  â”‚â”‚
â”‚ â”‚ Type: Date                                   [Delete] â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                            â”‚
â”‚                                             [Close]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Add/Edit Field Dialog:**

```
â”Œâ”€ Add Custom Field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚
â”‚ Field Name: [effort_______________]              â”‚
â”‚ (Internal name, no spaces)                       â”‚
â”‚                                                   â”‚
â”‚ Display Label: [Effort_____________]             â”‚
â”‚                                                   â”‚
â”‚ Type: [Single-select â–¼]                          â”‚
â”‚       â€¢ Single-select                            â”‚
â”‚       â€¢ Multi-select                             â”‚
â”‚       â€¢ Text                                     â”‚
â”‚       â€¢ Number                                   â”‚
â”‚       â€¢ Date                                     â”‚
â”‚       â€¢ Checkbox                                 â”‚
â”‚       â€¢ URL                                      â”‚
â”‚                                                   â”‚
â”‚ Options: (one per line)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ â”‚ low                   â”‚                        â”‚
â”‚ â”‚ medium                â”‚                        â”‚
â”‚ â”‚ high                  â”‚                        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                   â”‚
â”‚ Default Value: [none â–¼]                          â”‚
â”‚                                                   â”‚
â”‚ â˜ Required field                                 â”‚
â”‚                                                   â”‚
â”‚ Help Text: [Estimated effort level_________]     â”‚
â”‚                                                   â”‚
â”‚                          [Save] [Cancel]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Note Editor - Fields Section

**Fields appear between title and content:**

```
â”Œâ”€ Edit Note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Ã— Cancel]          Edit Note                    [Save]  â”‚ (mobile)
â”‚                                                            â”‚
â”‚ Title: [The Phoenix Project_____________________________] â”‚
â”‚                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ First Class Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                            â”‚
â”‚ Priority: [High â–¼]                 Status: To do â—‹        â”‚
â”‚                                           Done âœ“          â”‚
â”‚                                           Partial â—       â”‚
â”‚                                           None            â”‚
â”‚                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Custom Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                            â”‚
â”‚ Effort: [Medium â–¼]                 Rating: [5_____]       â”‚
â”‚                                                            â”‚
â”‚ Author: [Gene Kim___________________]                     â”‚
â”‚                                                            â”‚
â”‚ Date Read: [2026-01-15 ğŸ“…]                                â”‚
â”‚                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚                                                            â”‚
â”‚ Content:                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Great book about DevOps and IT management.             â”‚â”‚
â”‚ â”‚                                                        â”‚â”‚
â”‚ â”‚ Key takeaways:                                         â”‚â”‚
â”‚ â”‚ - Theory of Constraints applies to IT                 â”‚â”‚
â”‚ â”‚ - Importance of flow and feedback                     â”‚â”‚
â”‚ â”‚                                                        â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                            â”‚
â”‚ Tags: #business #devops                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚     â”‚ â”‚      â”‚ (colored pills)                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                            â”‚
â”‚                     [Delete Note]                          â”‚
â”‚                                                            â”‚
â”‚                                [Step In]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Field Layout:**
- First Class Fields first (priority, completion)
- Horizontal layout for compactness (2 fields per row)
- Second Class Fields below (custom fields)
- Visual separator between sections
- Fields in order they were defined in settings

---

## IMPLEMENTED: Note Editor - Custom Fields (v173-179)

**Actual implementation uses dropdowns instead of button groups for compactness:**

**Single-Select Fields:**
```
Effort: [Medium â–¼]
        â”œ None
        â”œ low
        â”œ medium  â† selected
        â”œ high
        â”” (add new...)
```
- Standard HTML `<select>` dropdown
- "None" option to clear value
- "(add new...)" at bottom to add options on-the-fly
- Selecting "(add new...)" prompts for new option
- New option added to field definition and auto-selected

**Multi-Select Fields:**
```
Technologies: [React, Node â–¼]  â† Click to open
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ â˜‘ React            â”‚
              â”‚ â˜ Python           â”‚
              â”‚ â˜‘ Node             â”‚
              â”‚ â˜ Go               â”‚
              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
              â”‚ (add new...)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Custom dropdown button shows selected items
- Click button to open/close checkbox menu
- Menu stays open while selecting
- Closes when clicking outside
- Checkboxes for multiple selections
- "(add new...)" at bottom (italic, accent color, separator line)
- Clicking "(add new...)" prompts and re-renders with new option

**Features Implemented:**
- Generalized field renderer registry (easy to add new types)
- Batch mode: unanimous values shown, mixed values empty
- Add options on-the-fly without leaving editor
- Auto-save field definition changes
- Load/save from node.fields.{fieldName}
- Positioned between Priority and Editor buttons
- Hidden when no custom fields defined

---

## Node Display - First Class Fields Only

**Current node (completion only):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ The Phoenix Project     â”‚
â”‚                         â”‚
â”‚ #business #devops    âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**With priority field (option 1: top-left dot):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¬¤ The Phoenix Project  â”‚ â† Orange dot = high priority
â”‚                         â”‚
â”‚ #business #devops    âœ“  â”‚ â† Checkmark = completed
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**With priority field (option 2: color-coded border):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† Orange left border = high
â”‚ The Phoenix Project     â”‚
â”‚                         â”‚
â”‚ #business #devops    âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**With priority field (option 3: badge/pill):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [H] The Phoenix Project â”‚ â† [H] badge = high priority
â”‚                         â”‚
â”‚ #business #devops    âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Second Class Fields NOT shown on node** (editor/sidebar/list view only)

**Priority Indicator Specifications:**

Option 1 (Colored Dot) - RECOMMENDED:
- 8px diameter circle
- Position: 6px from left edge, vertically centered with title
- Colors: Red (urgent), Orange (high), Yellow (normal), Blue (low)
- No dot if priority is null/none
- Rendered before title text

Option 2 (Color-Coded Border):
- 4px solid left border on node body
- Full height of node
- Colors: Same as option 1
- No border if priority is null/none

Option 3 (Badge/Pill):
- Small pill with letter: [U] [H] [N] [L]
- Position: Before title or after title
- Background color matches priority
- White text

**Decision needed:** Which priority indicator design to use?

---

## Fields Sidebar (New)

**New toolbar button to open Fields sidebar:**

```
Toolbar: [âŒ‚] [+] [â¬‡] [â›¶] [â—] [ğŸ”] [#] [ğŸ“‹] [?]
                                    â†‘    â†‘
                                 Tags  Fields
```

**Fields Sidebar UI:**

```
â”Œâ”€ Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Ã— Close]                      â”‚
â”‚                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€ First Class â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                â”‚
â”‚ Priority                       â”‚
â”‚ â¬¤ Urgent (3)                  â”‚ â† Click to filter
â”‚ â¬¤ High (5)                    â”‚
â”‚ â¬¤ Normal (12)                 â”‚
â”‚ â¬¤ Low (2)                     â”‚
â”‚ â—‹ None (8)                    â”‚
â”‚                                â”‚
â”‚ Completion                     â”‚
â”‚ â—‹ To do (8)                   â”‚
â”‚ âœ“ Done (10)                   â”‚
â”‚ â— Partial (2)                 â”‚
â”‚ â—‹ None (10)                   â”‚
â”‚                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€ Custom Fields â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                â”‚
â”‚ Effort                         â”‚
â”‚ â€¢ Low (4)                      â”‚
â”‚ â€¢ Medium (6)                   â”‚
â”‚ â€¢ High (3)                     â”‚
â”‚ â€¢ (not set) (17)               â”‚
â”‚                                â”‚
â”‚ Rating                         â”‚
â”‚ â˜…â˜…â˜…â˜…â˜… (5) - 3 notes           â”‚
â”‚ â˜…â˜…â˜…â˜…â˜† (4) - 2 notes           â”‚
â”‚ â˜…â˜…â˜…â˜†â˜† (3) - 1 note            â”‚
â”‚                                â”‚
â”‚ [Manage Fields...]             â”‚
â”‚ (opens settings)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Behavior:**
- Click field value â†’ filters to show only matching notes
- Active filters highlighted (like hashtag sidebar)
- Shows count for each value
- "(not set)" for notes without field value
- "Manage Fields" button opens settings modal Custom Fields tab

**Keyboard Shortcut:**
- F key â†’ Toggle Fields sidebar
- (H already used for hashtag sidebar)

---

## List View (Future Feature)

**Fields as columns in table view:**

```
â”Œâ”€ List View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚ Title                    Priority  Status    Effort  Rating  Tags  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ The Phoenix Project      â¬¤ High    âœ“ Done   Medium    5     2     â”‚
â”‚ Implement login          â¬¤ Urgent  â—‹ To do  High      -     1     â”‚
â”‚ Research frameworks      â¬¤ Normal  â— Part.  Low       4     3     â”‚
â”‚ Team meeting notes       -         -        -         -     1     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Sortable columns (click header)
- Field values in cells
- "-" for unset values
- Color coding for priority
- Icons for completion

================================================================================
HASHTAG MIGRATION TOOL
================================================================================

## Problem

Users may have existing notebooks using hashtags for structured data:
- #effort-low, #effort-medium, #effort-high
- #priority-urgent, #priority-normal
- #status-todo, #status-done

Migration tool converts these to proper custom fields automatically.

---

## Pattern Detection Algorithm

```javascript
function detectFieldPatterns(hashtags) {
  // Group hashtags by prefix pattern: #prefix-value
  const patterns = {};

  for (const tag of hashtags) {
    const match = tag.match(/^#([a-z]+)[-_]([a-z0-9]+)$/i);
    if (match) {
      const [, prefix, value] = match;
      if (!patterns[prefix]) {
        patterns[prefix] = new Set();
      }
      patterns[prefix].add(value);
    }
  }

  // Only suggest patterns with 2+ values
  return Object.entries(patterns)
    .filter(([prefix, values]) => values.size >= 2)
    .map(([prefix, values]) => ({
      prefix,
      values: Array.from(values).sort(),
      count: countNotesWithPattern(prefix)
    }));
}
```

**Example Detection:**

Input hashtags:
- #effort-low (8 notes)
- #effort-medium (12 notes)
- #effort-high (5 notes)
- #priority-urgent (3 notes)
- #priority-normal (15 notes)
- #status-todo (10 notes)
- #status-done (8 notes)

Detected patterns:
1. prefix: "effort", values: [low, medium, high], notes: 25
2. prefix: "priority", values: [normal, urgent], notes: 18
3. prefix: "status", values: [done, todo], notes: 18

---

## Migration Wizard UI

**Triggered by:**
- Settings â†’ Custom Fields â†’ "Migrate from Hashtags" button
- Auto-detect on notebook load (optional, with user consent)

```
â”Œâ”€ Migrate Hashtags to Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚ We detected hashtag patterns that could be converted      â”‚
â”‚ to custom fields for better organization.                 â”‚
â”‚                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                            â”‚
â”‚ â˜‘ Effort (25 notes affected)                              â”‚
â”‚   Pattern: #effort-{value}                                â”‚
â”‚   â†’ Create field "effort"                                 â”‚
â”‚   â†’ Type: Single-select                                   â”‚
â”‚   â†’ Options: high, low, medium                            â”‚
â”‚   â†’ Remove hashtags after conversion                      â”‚
â”‚                                                            â”‚
â”‚ â˜‘ Priority (18 notes affected)                            â”‚
â”‚   Pattern: #priority-{value}                              â”‚
â”‚   â†’ Use First Class "priority" field                      â”‚
â”‚   â†’ Options: normal, urgent                               â”‚
â”‚   â†’ Remove hashtags after conversion                      â”‚
â”‚                                                            â”‚
â”‚ â˜ Status (18 notes affected)                              â”‚
â”‚   Pattern: #status-{value}                                â”‚
â”‚   â†’ Use First Class "completion" field                    â”‚
â”‚   â†’ Map: todoâ†’no, doneâ†’yes                                â”‚
â”‚   â†’ Remove hashtags after conversion                      â”‚
â”‚                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                            â”‚
â”‚ [Preview Changes] [Convert Selected] [Cancel]             â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Preview Mode:**

```
â”Œâ”€ Preview: Effort Field Conversion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚ The following changes will be made:                        â”‚
â”‚                                                            â”‚
â”‚ Field Definition (Added):                                  â”‚
â”‚ - Name: effort                                             â”‚
â”‚ - Type: Single-select                                      â”‚
â”‚ - Options: high, low, medium                               â”‚
â”‚                                                            â”‚
â”‚ Notes Updated: 25                                          â”‚
â”‚                                                            â”‚
â”‚ Example:                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Before:                                                â”‚â”‚
â”‚ â”‚ Title: "Implement search"                              â”‚â”‚
â”‚ â”‚ Tags: #feature #effort-low #backend                    â”‚â”‚
â”‚ â”‚                                                        â”‚â”‚
â”‚ â”‚ After:                                                 â”‚â”‚
â”‚ â”‚ Title: "Implement search"                              â”‚â”‚
â”‚ â”‚ Fields: effort = low                                   â”‚â”‚
â”‚ â”‚ Tags: #feature #backend                                â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                            â”‚
â”‚                         [Proceed] [Cancel]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Migration Logic

```javascript
function migrateHashtagsToField(fieldName, tagPattern, fieldDef, removeHashtags) {
  // 1. Add field definition to notebook settings
  notebookSettings.customFields.push(fieldDef);

  // 2. For each note with matching hashtags
  for (const note of state.nodes) {
    for (const tag of note.hashtags) {
      const match = tag.match(tagPattern);
      if (match) {
        const value = match[1]; // Extract value from #prefix-value

        // Set field value
        if (!note.customFields) note.customFields = {};
        note.customFields[fieldName] = value;

        // Remove hashtag if requested
        if (removeHashtags) {
          note.hashtags = note.hashtags.filter(t => t !== tag);
        }
      }
    }
  }

  // 3. Save changes
  render();
  saveProjectToStorage();
}
```

**Special Case: Mapping to First Class Fields**

For #status-{value} â†’ completion field:

```javascript
const statusMapping = {
  'todo': 'no',
  'in-progress': 'partial',
  'done': 'yes',
  'complete': 'yes',
  'completed': 'yes'
};

function migrateStatusToCompletion() {
  for (const note of state.nodes) {
    for (const tag of note.hashtags) {
      const match = tag.match(/^#status[-_](.+)$/i);
      if (match) {
        const statusValue = match[1].toLowerCase();
        const completionValue = statusMapping[statusValue];

        if (completionValue) {
          note.completion = completionValue;
          note.hashtags = note.hashtags.filter(t => t !== tag);
        }
      }
    }
  }
}
```

================================================================================
FILTERING & SEARCH
================================================================================

## Field-Based Filtering

**Current filter logic (hashtags + text search):**
- Hashtag filter: OR logic (show notes with ANY selected tag)
- Text search: AND logic (must match all search terms)
- Combined: AND between hashtag and text (must match both)

**With custom fields:**

**Single Field Filter:**
- Filter by field value (e.g., priority = high)
- Accessible via Fields sidebar (click value)
- Can combine multiple field filters

**Multi-Field Filter:**
- AND logic between fields: priority = high AND effort = low
- "Quick Wins" filter preset: priority = (normal OR high) AND effort = low
- "Critical Path": priority = urgent AND completion = no

**Filter UI:**

```
Active Filters:
[Priority: High Ã—] [Effort: Low Ã—] [#urgent Ã—] [Clear All]
```

---

## Persistent Search Zones with Fields (Future)

**Zones can filter by field values:**

```
Zone: "Quick Wins"
Filter:
  priority IN [normal, high] AND
  effort = low AND
  completion = no
```

**Visual zone filtering:**
- Notes inside zone bounds match field criteria
- Color-coded zones (green = quick wins, red = urgent, etc.)
- Venn diagram overlaps (note in multiple zones if matches multiple filters)

---

## Search Operators (Future Enhancement)

**Advanced search syntax:**

```
priority:high              â†’ Priority is high
effort:low,medium          â†’ Effort is low OR medium
rating:>=4                 â†’ Rating 4 or 5
dateRead:2026-01          â†’ Read in January 2026
dateRead:>2026-01-01      â†’ Read after Jan 1
completion:no              â†’ To-do items
priority:! OR priority:null â†’ No priority set
```

================================================================================
IMPLEMENTATION PLAN
================================================================================

## Phase 0: Unified Field Storage [COMPLETED - v168]

**Goal:** Unify storage for First-Class and Second-Class fields

**Completed:**
- All fields stored in node.fields.{fieldName}
- Migration function for legacy top-level completion/priority
- getNodeFieldValue() / setNodeFieldValue() unified accessors
- Backwards compatible (auto-migrates on load)

---

## Phase 1: Priority Field (First Class) [COMPLETED - v166]

**Goal:** Add priority as the first new First Class Field

**Completed:**
- FIRST_CLASS_FIELDS config with completion + priority
- Priority indicator on node (bottom-right, arrow icons)
- Click to cycle priority states
- Editor buttons for priority selection
- Export/import includes priority

---

## Phase 1b: Generalized First Class Fields [COMPLETED - v167]

**Goal:** Generalize save/load for any First-Class field

**Completed:**
- Generic helpers: getAllFieldValues(), loadAllFieldValues(), etc.
- Adding new First-Class field requires only config + HTML
- No changes to save/load/snapshot logic

---

## Phase 1c: Generalized Field Infrastructure [COMPLETED - v169-170]

**Goal:** Extend infrastructure for Second-Class fields

**Completed:**
- getFieldDefinitions() - returns all field definitions
- getCustomFieldInputValue() / setCustomFieldInputValue()
- getFieldUsedValues() - collects values for auto-complete
- getFieldOptions() - hybrid predefined + auto-collected
- hasFieldSelection() - for batch mode None handling
- Settings UI for First-Class field defaults (v171)

---

## Phase 2: Custom Fields Settings UI [COMPLETED - v172-177]

**Goal:** Allow users to define Second Class Fields per notebook

**Completed:**
1. [x] Tabbed settings modal (General | Custom Fields tabs)
2. [x] Add "Custom Fields" section in settings modal
3. [x] Field editor modal for adding/editing field definitions
4. [x] Field type dropdown selector (single-select, multi-select)
5. [x] Field options textarea (one per line or comma-separated)
6. [x] Delete fields with confirmation
7. [x] Field cards showing name, type, options, Edit/Delete buttons
8. [x] Validation: field name format, duplicates, reserved names
9. [x] Works with both open and closed projects
10. [x] Auto-save integration

**Files Changed:** app.js, main.css, index.html

---

## Phase 3: Editor Integration [COMPLETED - v173-179]

**Goal:** Render Second-Class fields in note editor

**Completed:**
1. [x] Added custom-fields-container to editor HTML (between priority and buttons)
2. [x] Field type renderer registry pattern (FIELD_TYPE_RENDERERS)
3. [x] Single-select: HTML dropdown with "None" option
4. [x] Multi-select: Custom dropdown with checkboxes
5. [x] Batch mode support (unanimous values shown, mixed empty)
6. [x] "(add new...)" option in both field types to expand options on-the-fly
7. [x] Load/save functions for both types
8. [x] Auto-render based on projectSettings.customFields
9. [x] Empty state (container hidden if no fields)
10. [x] Styled consistently with First-Class fields

**Architecture:**
- Generalized renderer with type-specific render/load/save functions
- Easy to extend with new field types (text, number, date, etc.)
- Single source of truth: node.fields.{fieldName}

**Files Changed:** app.js, main.css, index.html

---

## Phase 4: Export/Import [COMPLETED - v180]

**Goal:** Include custom fields in export/import

**Completed:**
1. [x] Field definitions already exported in settings.customFields
2. [x] Node.fields values already exported with nodes
3. [x] Merge strategy for importing notebooks with different field schemas
4. [x] Conflict resolution modal when field names clash
5. [x] Batch resolution buttons ("Keep All Current" / "Use All Imported")
6. [x] Backwards compatibility with old exports (no customFields = works fine)

**Implementation:**
- mergeCustomFieldDefinitions() - Combines existing + imported fields, detects conflicts
- fieldDefinitionsMatch() - Compares field definitions for equality
- resolveFieldConflicts() - Modal for user to choose which definition to keep
- Updated handleImportOverwrite() - Merges fields before overwriting project
- Conflict modal HTML + CSS styling

**Files Changed:** app.js, main.css, index.html

---

## Phase 5: Fields Sidebar [FUTURE]

**Goal:** Provide UI for viewing field values and filtering

**Tasks:**
1. Add Fields button to toolbar (ğŸ“‹ icon)
2. Create Fields sidebar HTML structure
3. Populate sidebar with First Class + Second Class fields
4. Show value counts for each field option
5. Implement click-to-filter functionality
6. "Manage Fields" button â†’ opens settings
7. Keyboard shortcut (F key)
8. Style sidebar (similar to hashtag sidebar)

**Estimated Effort:** Medium (6-8 hours)

---

## Phase 6: Hashtag Migration Tool [FUTURE]

**Goal:** Convert existing hashtag patterns to custom fields

**Tasks:**
1. Build pattern detection algorithm
2. Create migration wizard UI
3. Preview mode showing changes
4. Batch conversion logic
5. Special handling for First Class field mapping
6. "Migrate from Hashtags" button in settings
7. Optional: Auto-detect on notebook open (with consent)
8. Test with various hashtag patterns

**Estimated Effort:** Medium (6-8 hours)

---

## Phase 7: Advanced Filtering [FUTURE]

**Goal:** Filter by field values, combine with zones

**Tasks:**
1. Field-based filter UI (active filters bar)
2. Multi-field AND logic
3. Field operators (>=, <=, IN, etc.)
4. Persistent Search Zones integration
5. Filter presets (save common field filters)
6. Search syntax parsing

**Estimated Effort:** High (12-16 hours)
**Deferred until:** Persistent Search Zones implemented

---

## Phase 8: List View with Fields [FUTURE]

**Goal:** Show fields as columns in table view

**Tasks:**
1. Implement list/table view mode
2. Fields as sortable columns
3. Inline editing of field values
4. Column visibility toggle
5. Export as CSV with fields

**Estimated Effort:** High (10-14 hours)
**Deferred until:** Multiple view modes implemented (design-spec-future.txt)

================================================================================
TECHNICAL CONSIDERATIONS
================================================================================

## Backwards Compatibility

**Old notebooks without custom fields:**
- Load normally (customFields array empty or undefined)
- Can add fields via settings
- No migration required

**Old notes without field values:**
- customFields object empty or undefined
- Display "(not set)" in UI
- Don't show field if value is null/undefined

**First Class Fields:**
- completion already exists (100% backwards compatible)
- priority is new (defaults to null, no visual if unset)

---

## Performance

**Field Rendering:**
- Generic field renderer handles all Second Class Fields
- No per-field custom logic (unlike First Class)
- Minimal performance impact

**Filtering:**
- Field-based filters are simple equality checks
- No complex queries initially (defer to Phase 5)
- Similar performance to current hashtag filtering

**Storage:**
- Fields stored in customFields object (compact)
- Only defined field values stored (not null/undefined)
- Field definitions in settings (shared, not per-note)

---

## Data Migration

**Adding fields to existing notebooks:**
- No data loss (additive only)
- Old notes display "(not set)" for new fields
- Can bulk-update field values (future enhancement)

**Removing field definitions:**
- Prompt: "Delete field values in all notes?"
- Option 1: Remove field definition and all values
- Option 2: Remove definition but keep values (orphaned data)

**Renaming fields:**
- Update field definition name
- Update all note customFields keys
- Preserve values

---

## Validation

**Field Definition Validation:**
- Name must be unique within notebook
- Name must be valid identifier (alphanumeric + underscore)
- Single/multi-select must have 1+ options
- Number fields can have min/max constraints
- Text fields can have max length

**Field Value Validation:**
- Single-select: value must be in options list
- Number: must be valid number, within min/max
- Date: must be valid ISO date format
- URL: must be valid URL format
- Required fields: must have non-null value

**Handling Invalid Values:**
- On load: Ignore invalid values (treat as unset)
- On save: Validate before persisting
- On edit: Show validation errors in editor

================================================================================
EDGE CASES & ERROR HANDLING
================================================================================

## Field Definition Changes

**Scenario 1: Remove option from single-select**
- Field "effort" has options [low, medium, high]
- User removes "medium" option
- 12 notes have effort = medium

**Resolution:**
- Warn user: "12 notes have value 'medium'. Remove anyway?"
- If yes: Set affected notes' field to null (unset)
- If no: Keep option

---

**Scenario 2: Change field type**
- Field "rating" is text, some notes have "5 stars"
- User changes to number type

**Resolution:**
- Warn user: "Changing type will clear existing values. Proceed?"
- If yes: Clear all values for this field
- If no: Cancel type change

**Better approach:** Don't allow type changes, only delete/recreate

---

## Field Name Conflicts

**Scenario: User creates field with same name as First Class Field**
- User tries to create custom field "priority"
- First Class Field "priority" already exists

**Resolution:**
- Validate on save: "Field name 'priority' is reserved. Choose another."
- Reserved names: completion, priority, (future First Class Fields)

---

## Export/Import with Fields

**Exporting notebook with custom fields:**
- Include field definitions in JSON
- Include field values in each note

**Importing into notebook with different fields:**
- Option 1: Merge field definitions (add new, keep existing)
- Option 2: Overwrite field definitions (replace all)
- Option 3: Skip field definitions (only import notes)

**User prompt:**
```
Imported notebook has different custom fields.
Imported fields: effort, author, dateRead
Current fields: priority, sprint, owner

[Merge] [Replace] [Skip] [Cancel]
```

---

## Required Fields

**If field marked as required:**
- Must have value before saving note
- Editor shows validation error if empty
- Can't set completion = done if required fields empty

**Use cases:**
- Enforce data entry (e.g., "all tasks must have effort")
- Prevent incomplete records

**Implementation:**
- Add "required" boolean to field definition
- Validate on note save
- Show asterisk (*) next to required field labels

================================================================================
FUTURE ENHANCEMENTS
================================================================================

## Calculated Fields

**Auto-compute field values based on other fields:**

Example: Effort Score
- Formula: priority weight Ã— effort weight
- priority: urgent=4, high=3, normal=2, low=1
- effort: high=3, medium=2, low=1
- Score: priority Ã— effort (max 12, min 1)

**Use cases:**
- Prioritization scores
- Progress percentage (completed children / total children)
- Days until due date

---

## Field Dependencies

**Fields that show/hide based on other field values:**

Example:
- If completion = done, show "Date Completed" field
- If priority = urgent, require "Escalation Reason" field

**Use cases:**
- Conditional data entry
- Context-dependent fields

---

## Field Templates

**Pre-defined field sets for common use cases:**

```
Templates:
- Task Management (effort, priority, assignee, sprint)
- Book Collection (author, genre, rating, dateRead)
- Research Notes (source, methodology, year, confidence)
- CRM (company, role, lastContact, relationship)
```

**User flow:**
1. Settings â†’ Custom Fields â†’ [Load Template â–¼]
2. Select template
3. Fields auto-created
4. Can customize after loading

---

## Bulk Field Editing

**Update field values for multiple notes at once:**

```
Select 5 notes â†’ Right-click â†’ "Set field value"
â†’ Choose field: effort
â†’ Choose value: low
â†’ All 5 notes updated
```

**Use cases:**
- Batch categorization
- Quick updates after filtering

---

## Field-Based Sorting

**Sort nodes on canvas by field value:**

```
View â†’ Sort by â†’ Priority (High to Low)
â†’ Nodes auto-arrange: Urgent â†’ High â†’ Normal â†’ Low â†’ None
```

**Layout options:**
- Horizontal line (left to right)
- Vertical line (top to bottom)
- Grid (group by value)

---

## Field Statistics

**Dashboard showing field value distributions:**

```
Field Summary:
Priority: 30% urgent, 20% high, 40% normal, 10% low
Effort: 15% high, 50% medium, 35% low
Completion: 35% done, 45% to-do, 20% partial
```

**Use cases:**
- Project health at a glance
- Identify imbalances (too many urgent tasks)

================================================================================
OPEN QUESTIONS
================================================================================

1. **Priority Indicator Design**
   - Option 1: Colored dot (left of title) â† RECOMMENDED
   - Option 2: Color-coded left border
   - Option 3: Badge with letter [U][H][N][L]
   Decision needed before Phase 1

2. **Fields Sidebar Icon**
   - ğŸ“‹ Clipboard
   - âš¡ Bolt/Lightning
   - ğŸ·ï¸ Label/Tag
   - â¬¡ Hexagon
   - â–¦ Grid
   Decision needed before Phase 3

3. **Field Name Restrictions**
   - Allow spaces in names? (displayed as "Date Read" but stored as "dateRead")
   - Max length for field names?
   - Reserved words beyond First Class Field names?

4. **Multi-Select Display**
   - How to show multi-select values in editor?
   - Checkboxes? Tag-style pills? Dropdown with checkmarks?

5. **Date Field Format**
   - Display: MM/DD/YYYY vs DD/MM/YYYY vs YYYY-MM-DD?
   - User preference or auto-detect from locale?

6. **Number Field Precision**
   - Allow decimals? (e.g., 3.5 for rating)
   - Or integers only?
   - Specify per field?

7. **Required Fields Enforcement**
   - Block save if required fields empty?
   - Or just show warning and allow save anyway?

8. **Field Value History**
   - Track when field values change?
   - Show edit history for fields?
   - Probably overkill, but useful for audit trail

9. **Field-Level Permissions** (Far Future)
   - Read-only fields (calculated, system-managed)
   - User-editable vs admin-only
   - Relevant if multi-user features added

10. **Integration with Completion**
    - Auto-set completion = done when all required fields filled?
    - Or keep completion independent?

================================================================================
SUCCESS CRITERIA
================================================================================

Custom Fields feature is successful if:

1. **Reduces Hashtag Pollution**
   - Users migrate structured data from hashtags to fields
   - Hashtags used for true categorization, not metadata

2. **Improves Data Quality**
   - Fewer typos (dropdowns vs free text)
   - Consistent values (enforced options)
   - Required fields ensure completeness

3. **Enables Better Filtering**
   - Users can find notes by field values easily
   - Multi-field filters create powerful queries
   - Persistent Search Zones use field criteria

4. **Flexible for Different Use Cases**
   - Book collectors, project managers, researchers all benefit
   - Second Class Fields adapt to user needs
   - First Class Fields provide baseline for all

5. **Easy to Use**
   - Intuitive UI for creating/editing fields
   - Migration tool works smoothly
   - Fields sidebar makes filtering discoverable

6. **Performs Well**
   - No noticeable lag with 100+ notes, 10+ fields
   - Fast filtering/sorting by field values
   - Minimal storage overhead

7. **Future-Proof**
   - Integrates well with flat architecture (design-spec-future.txt)
   - Works with Persistent Search Zones
   - Compatible with List/Table view
   - Foundation for calculated fields, templates, etc.

================================================================================
REFERENCES
================================================================================

**Similar Implementations:**
- Notion: Properties (flexible, per-page types)
- Airtable: Fields (database-style, typed columns)
- Obsidian: Properties (YAML frontmatter, key-value pairs)
- Roam Research: Attributes (page properties, typed)
- Coda: Columns (table-based, typed with formulas)

**Knotebook's Unique Combination:**
- Two-tier system (First Class + Second Class)
- Visual indicators on canvas (First Class Fields)
- Per-notebook schemas (Second Class Fields)
- Migration from hashtags (unique to this context)
- Integration with spatial canvas + zones

================================================================================
