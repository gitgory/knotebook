<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>knotebook</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="styles/main.css?v=232">
</head>
<body>
    <div id="app">
        <!-- Landing Page -->
        <div id="landing-page">
            <div id="landing-content">
                <h1><span class="knote">knote</span>book</h1>
                <p>A visual note-taking app with graph structure</p>
                <div id="landing-buttons">
                    <button id="new-project-btn">New Notebook</button>
                    <button id="import-project-btn">Import from File</button>
                </div>
                <div id="projects-section">
                    <h2>Your Notebooks</h2>
                    <div id="projects-list"></div>
                </div>
                <div id="version-info"></div>

                <!-- Debug Tools (hidden by default) -->
                <div id="debug-tools" class="hidden">
                    <h3>üõ†Ô∏è Developer Tools</h3>
                    <div id="debug-buttons">
                        <button id="debug-fill-storage">Fill localStorage</button>
                        <button id="debug-clear-test-data">Clear test data</button>
                        <button id="debug-check-usage">Check storage usage</button>
                    </div>
                    <div id="debug-output"></div>
                </div>
            </div>
        </div>

        <!-- New Project Modal -->
        <div id="new-project-modal" class="hidden">
            <div id="new-project-content">
                <h3>New Notebook</h3>
                <input type="text" id="new-project-name" placeholder="Notebook name...">
                <div id="new-project-buttons">
                    <button id="new-project-create">Create</button>
                    <button id="new-project-cancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Project Menu (context menu for project actions) -->
        <div id="project-menu" class="hidden">
            <button class="project-menu-item" data-action="rename">Rename</button>
            <button class="project-menu-item" data-action="settings">Settings</button>
            <button class="project-menu-item" data-action="export">Export to File</button>
            <button class="project-menu-item danger" data-action="delete">Delete</button>
        </div>

        <!-- Import Options Modal -->
        <!-- Field Conflict Resolution Modal -->
        <div id="field-conflict-modal" class="hidden">
            <div id="field-conflict-content">
                <h3>Custom Field Conflicts</h3>
                <p class="conflict-explanation">
                    The imported notebook has custom fields with the same names but different definitions.
                    Choose which definition to keep for each field:
                </p>

                <div id="conflict-list"></div>

                <div id="conflict-batch-buttons">
                    <button id="conflict-keep-all" class="secondary">Keep All Current</button>
                    <button id="conflict-use-all" class="secondary">Use All Imported</button>
                </div>

                <div id="field-conflict-buttons">
                    <button id="conflict-resolve-btn">Continue Import</button>
                    <button id="conflict-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Graph View -->
        <div id="graph-view" class="hidden">
            <!-- Toolbar -->
            <div id="toolbar">
                <button id="home-btn" title="Back to Home">‚åÇ</button>
                <button id="add-node-btn" title="Add Note">+</button>
                <button id="save-btn" title="Export to File">‚¨á</button>
                <button id="fit-view-btn" title="Fit graph to view">‚õ∂</button>
                <button id="hashtag-sidebar-btn" title="Tags (H)">#</button>
                <div id="theme-selector">
                    <button id="theme-toggle" title="Change theme">‚óê</button>
                    <div id="theme-dropdown" class="hidden">
                        <button class="theme-option active" data-theme="midnight">Midnight</button>
                        <button class="theme-option" data-theme="slate">Slate</button>
                        <button class="theme-option" data-theme="neon">Neon</button>
                        <button class="theme-option" data-theme="mint">Mint</button>
                        <button class="theme-option" data-theme="ocean">Ocean</button>
                        <button class="theme-option" data-theme="sky">Sky</button>
                        <button class="theme-option" data-theme="obsidian">Obsidian</button>
                        <button class="theme-option" data-theme="aurora">Aurora</button>
                        <button class="theme-option" data-theme="graphite">Graphite</button>
                        <button class="theme-option" data-theme="sunset">Sunset</button>
                    </div>
                </div>
                <button id="help-btn" title="Keyboard shortcuts">?</button>
                <button id="settings-btn" title="Notebook settings">‚öô</button>
                <div id="text-search">
                    <input type="text" id="text-search-input" placeholder="Search..." title="Search notes (S)">
                    <button id="text-search-clear" class="hidden" title="Clear search">√ó</button>
                </div>
                <div id="save-status" class="save-status saved">
                    <span class="save-icon">‚úì</span>
                    <span class="save-text">Saved</span>
                </div>
                <div id="breadcrumbs" class="breadcrumb-trail"></div>
            </div>

            <!-- Main canvas area -->
            <div id="canvas-container">
                <svg id="canvas">
                    <!-- Arrow markers for directed edges -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent)" />
                        </marker>
                        <marker id="arrowhead-selected" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--highlight)" />
                        </marker>
                    </defs>
                    <!-- Edges will be rendered here (below nodes) -->
                    <g id="edges-layer"></g>
                    <!-- Nodes will be rendered here -->
                    <g id="nodes-layer"></g>
                    <!-- Ghost nodes for move operation (above normal nodes) -->
                    <g id="ghost-layer"></g>
                    <!-- Selection box overlay (for drag-selection) -->
                    <g id="selection-box-overlay"></g>
                </svg>
            </div>

            <!-- Selection action bar (mobile) -->
            <div id="selection-action-bar" class="hidden">
                <button id="action-connect" class="action-btn" data-action="connect">Connect</button>
                <button id="action-duplicate" class="action-btn" data-action="duplicate">Duplicate</button>
                <button id="action-bring-front" class="action-btn" data-action="bring-front">To Front</button>
                <button id="action-send-back" class="action-btn" data-action="send-back">To Back</button>
                <button id="action-move-to" class="action-btn" data-action="move-to">Move to...</button>
                <button id="action-delete" class="action-btn" data-action="delete">Delete</button>
            </div>

            <!-- Hashtag sidebar -->
            <div id="hashtag-sidebar" class="hidden">
                <div id="sidebar-header">
                    <span>Tags</span>
                    <button id="sidebar-close" title="Close">√ó</button>
                </div>
                <div id="hashtag-search">
                    <input type="text" id="hashtag-input" placeholder="Filter by tag..." title="Filter by tag (/)">
                    <button id="hashtag-clear" class="hidden" title="Clear filter">√ó</button>
                </div>
                <div id="sidebar-content">
                    <div id="hashtag-list"></div>
                </div>
            </div>
        </div>

        <!-- Note editor modal -->
        <div id="editor-modal" class="hidden">
            <div id="editor-content">
                <div id="editor-header">
                    <h3>Edit Note</h3>
                    <button id="editor-cancel">√ó</button>
                </div>
                <input type="text" id="note-title" placeholder="Note title..." spellcheck="false">
                <textarea id="note-text" placeholder="Enter your note..." spellcheck="false"></textarea>
                <div id="hashtag-display"></div>
                <div id="completion-control">
                    <span id="completion-label">Status:</span>
                    <button class="completion-btn" data-value="">None</button>
                    <button class="completion-btn" data-value="no">To do</button>
                    <button class="completion-btn" data-value="partial">Partial</button>
                    <button class="completion-btn" data-value="yes">Done</button>
                    <button class="completion-btn" data-value="cancelled">Cancelled</button>
                </div>
                <div id="priority-control">
                    <span id="priority-label">Priority:</span>
                    <button class="priority-btn" data-value="">None</button>
                    <button class="priority-btn" data-value="low">Low</button>
                    <button class="priority-btn" data-value="medium">Medium</button>
                    <button class="priority-btn" data-value="high">High</button>
                    <button class="priority-btn" data-value="top">Top</button>
                </div>
                <div id="custom-fields-container"></div>
                <div id="editor-buttons">
                    <button id="editor-enter">Step in</button>
                    <button id="editor-save-mobile" class="mobile-only">Save</button>
                </div>
            </div>
        </div>

        <!-- Settings modal -->
        <div id="settings-modal" class="hidden">
            <div id="settings-content">
                <h3>Notebook Settings</h3>

                <!-- Tab Navigation -->
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="general">General</button>
                    <button class="settings-tab" data-tab="custom-fields">Custom Fields</button>
                </div>

                <!-- General Tab -->
                <div id="settings-tab-general" class="settings-tab-panel active">
                    <div class="settings-row">
                        <span class="settings-label">Default completion status</span>
                        <select id="settings-completion-default" class="settings-select">
                            <option value="">None</option>
                            <option value="no">To do</option>
                            <option value="partial">Partial</option>
                            <option value="yes">Done</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Default priority level</span>
                        <select id="settings-priority-default" class="settings-select">
                            <option value="">None</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="top">Top</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Fields Tab -->
                <div id="settings-tab-custom-fields" class="settings-tab-panel">
                    <p class="settings-description">
                        Define fields for notes in this notebook. Fields appear in the note editor and can be used for filtering.
                    </p>
                    <button id="settings-add-field" class="settings-add-btn">+ Add Field</button>
                    <div id="settings-custom-fields-list"></div>
                </div>

                <div id="settings-buttons">
                    <button id="settings-close">Close</button>
                </div>
            </div>
        </div>

        <!-- Field Editor modal -->
        <div id="field-editor-modal" class="hidden">
            <div id="field-editor-content">
                <h3 id="field-editor-title">Add Custom Field</h3>
                <div class="field-editor-row">
                    <label for="field-editor-name">Field name:</label>
                    <input type="text" id="field-editor-name" placeholder="e.g., effort">
                    <span class="field-hint">Internal name, no spaces (a-z, 0-9, _)</span>
                </div>
                <div class="field-editor-row">
                    <label for="field-editor-label">Display label:</label>
                    <input type="text" id="field-editor-label" placeholder="e.g., Effort Level">
                </div>
                <div class="field-editor-row">
                    <label for="field-editor-type">Field type:</label>
                    <select id="field-editor-type" class="settings-select">
                        <option value="single-select">Single-select (one choice)</option>
                        <option value="multi-select">Multi-select (multiple choices)</option>
                    </select>
                </div>
                <div class="field-editor-row">
                    <label for="field-editor-options">Options:</label>
                    <textarea id="field-editor-options" placeholder="One option per line or comma-separated"></textarea>
                    <span class="field-hint">Enter one option per line, or separate with commas</span>
                </div>
                <div id="field-editor-buttons">
                    <button id="field-editor-save">Save</button>
                    <button id="field-editor-cancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Move to Notebook modal -->
        <div id="move-to-modal" class="hidden">
            <div id="move-to-content">
                <h3>Move to Notebook</h3>
                <div id="move-to-list"></div>
                <button id="move-to-cancel">Cancel</button>
            </div>
        </div>

        <!-- Select Notebook to Overwrite modal -->
        <div id="overwrite-select-modal" class="hidden">
            <div id="overwrite-select-content">
                <h3>Select Notebook to Overwrite</h3>
                <div id="overwrite-select-list"></div>
                <button id="overwrite-select-cancel">Cancel</button>
            </div>
        </div>

        <!-- Confirmation modal -->
        <div id="confirm-modal" class="hidden">
            <div id="confirm-content">
                <p id="confirm-message"></p>
                <div id="confirm-buttons">
                    <button id="confirm-yes">Yes</button>
                    <button id="confirm-no">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Help modal -->
        <div id="help-modal" class="hidden">
            <div id="help-content">
                <!-- Desktop help -->
                <div id="help-desktop">
                    <h3>Keyboard Shortcuts</h3>
                    <div id="help-shortcuts">
                        <div class="shortcut-section">
                            <h4>File</h4>
                            <div class="shortcut-row"><span class="key">Ctrl+S</span> Export to file</div>
                            <div class="shortcut-row"><span class="key">Ctrl+Z</span> Undo</div>
                        </div>
                        <div class="shortcut-section">
                            <h4>Notes</h4>
                            <div class="shortcut-row"><span class="key">N</span> New note</div>
                            <div class="shortcut-row"><span class="key">Enter</span> Edit selected note</div>
                            <div class="shortcut-row"><span class="key">C</span> Connect (create edge)</div>
                            <div class="shortcut-row"><span class="key">Delete</span> Delete selected</div>
                            <div class="shortcut-row"><span class="key">S</span> Search notes</div>
                            <div class="shortcut-row"><span class="key">/</span> Filter by tag (in sidebar)</div>
                            <div class="shortcut-row"><span class="key">H</span> Toggle tag sidebar</div>
                            <div class="shortcut-row"><span class="key">Escape</span> Save &amp; close editor / clear</div>
                            <div class="shortcut-row"><span class="key">Shift+Enter</span> New line in note body</div>
                        </div>
                        <div class="shortcut-section">
                            <h4>View</h4>
                            <div class="shortcut-row"><span class="key">F</span> Fit to view</div>
                            <div class="shortcut-row"><span class="key">+</span> Zoom in</div>
                            <div class="shortcut-row"><span class="key">-</span> Zoom out</div>
                            <div class="shortcut-row"><span class="key">0</span> Reset zoom (100%)</div>
                            <div class="shortcut-row"><span class="key">Space+Drag</span> Pan (preserve selection)</div>
                            <div class="shortcut-row"><span class="key">Ctrl+]</span> Bring to front</div>
                            <div class="shortcut-row"><span class="key">Ctrl+[</span> Send to back</div>
                            <div class="shortcut-row"><span class="key">Alt+‚Üë</span> Go back</div>
                            <div class="shortcut-row"><span class="key">?</span> Show this help</div>
                        </div>
                        <div class="shortcut-section">
                            <h4>Mouse</h4>
                            <div class="shortcut-row"><span class="key">Drag</span> Move note(s)</div>
                            <div class="shortcut-row"><span class="key">Double-click</span> Edit note</div>
                            <div class="shortcut-row"><span class="key">Right-click</span> Note context menu</div>
                            <div class="shortcut-row"><span class="key">Ctrl+Click</span> Multi-select</div>
                            <div class="shortcut-row"><span class="key">Ctrl+Drag</span> Duplicate note(s)</div>
                            <div class="shortcut-row"><span class="key">Drag ‚Üí right</span> Selection box (enclosed)</div>
                            <div class="shortcut-row"><span class="key">Drag ‚Üê left</span> Selection box (intersecting)</div>
                            <div class="shortcut-row"><span class="key">Right-drag empty</span> Pan (preserve selection)</div>
                            <div class="shortcut-row"><span class="key">Shift+click</span> Toggle edge</div>
                            <div class="shortcut-row"><span class="key">Shift+drag</span> Draw edge</div>
                            <div class="shortcut-row"><span class="key">Click [n]</span> Enter note</div>
                            <div class="shortcut-row"><span class="key">Scroll</span> Zoom</div>
                        </div>
                    </div>
                </div>
                <!-- Mobile help -->
                <div id="help-mobile">
                    <h3>Touch Controls</h3>
                    <div id="help-shortcuts">
                        <div class="shortcut-section">
                            <h4>Notes</h4>
                            <div class="shortcut-row"><span class="key">Tap</span> Select note</div>
                            <div class="shortcut-row"><span class="key">Double-tap</span> Edit note</div>
                            <div class="shortcut-row"><span class="key">Long-press note</span> Add to selection, enable tap-to-add</div>
                            <div class="shortcut-row"><span class="key">Tap (after long-press)</span> Add more to selection</div>
                            <div class="shortcut-row"><span class="key">Tap selected</span> Show actions</div>
                            <div class="shortcut-row"><span class="key">Touch drag</span> Move note(s)</div>
                            <div class="shortcut-row"><span class="key">Tap edge</span> Select edge</div>
                        </div>
                        <div class="shortcut-section">
                            <h4>Canvas</h4>
                            <div class="shortcut-row"><span class="key">Touch drag</span> Pan canvas</div>
                            <div class="shortcut-row"><span class="key">Long-press empty</span> Selection box (drag to select)</div>
                            <div class="shortcut-row"><span class="key">Pinch</span> Zoom in/out</div>
                            <div class="shortcut-row"><span class="key">Tap empty</span> Deselect / cancel</div>
                        </div>
                        <div class="shortcut-section">
                            <h4>Toolbar</h4>
                            <div class="shortcut-row"><span class="key">+</span> New note</div>
                            <div class="shortcut-row"><span class="key">‚¨á</span> Export to file</div>
                            <div class="shortcut-row"><span class="key">‚õ∂</span> Fit to view</div>
                            <div class="shortcut-row"><span class="key">#</span> Tag sidebar</div>
                        </div>
                    </div>
                </div>
                <button id="help-close">Close</button>
            </div>
        </div>

        <!-- Hashtag autocomplete dropdown -->
        <div id="hashtag-autocomplete" class="hidden">
            <div id="hashtag-autocomplete-list"></div>
        </div>

        <!-- Alert Modal -->
        <div id="alert-modal" class="hidden">
            <div id="alert-content">
                <h3 id="alert-title">Alert</h3>
                <p id="alert-message"></p>
                <div id="alert-buttons">
                    <button id="alert-ok">OK</button>
                </div>
            </div>
        </div>

        <!-- Prompt Modal -->
        <div id="prompt-modal" class="hidden">
            <div id="prompt-content">
                <h3 id="prompt-title">Input Required</h3>
                <p id="prompt-message"></p>
                <input type="text" id="prompt-input" placeholder="">
                <div id="prompt-buttons">
                    <button id="prompt-ok">OK</button>
                    <button id="prompt-cancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Error Recovery Modal -->
        <div id="error-modal" class="hidden">
            <div id="error-content">
                <h3>‚ö†Ô∏è Something went wrong</h3>
                <p id="error-message">An unexpected error occurred. You can try to recover your work or reload the app.</p>
                <details id="error-details">
                    <summary>Technical details</summary>
                    <pre id="error-stack"></pre>
                </details>
                <div id="error-buttons">
                    <button id="error-export">Export Current Data</button>
                    <button id="error-reload">Reload App</button>
                    <button id="error-continue">Try to Continue</button>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/app.js?v=232"></script>
    <script>
        // Extract version numbers from script and link tags
        (function() {
            const cssLink = document.querySelector('link[href*="main.css"]');
            const jsScript = document.querySelector('script[src*="app.js"]');

            const cssVersion = cssLink ? new URL(cssLink.href, window.location.href).searchParams.get('v') : 'unknown';
            const jsVersion = jsScript ? new URL(jsScript.src, window.location.href).searchParams.get('v') : 'unknown';

            const versionInfo = document.getElementById('version-info');
            if (versionInfo) {
                versionInfo.textContent = `CSS v${cssVersion} | JS v${jsVersion}`;
            }
        })();
    </script>
</body>
</html>