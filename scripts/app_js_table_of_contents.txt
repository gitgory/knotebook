Parsing G:\My Drive\Claude Projects\knotebook\scripts\app.js...
Generated G:\My Drive\Claude Projects\knotebook\scripts\app_js_table_of_contents.txt
  780 lines
==========
// ERROR HANDLING (line 6)
// ============================================================================
    // Global error boundary - catches all uncaught exceptions
    // Global promise rejection handler
function showErrorRecoveryUI(error)  // line 32
        // Fallback if modal doesn't exist yet
        // Set error message
        // Set stack trace
        // Show modal
function hideErrorRecoveryUI()  // line 62
        // Try to export current project if one is open
        // Export all projects list
// ============================================================================
// DATA STRUCTURES (line 98)
// ============================================================================
    // Application state - single source of truth
    // All mutable application state is consolidated here for easier debugging
    // and predictable data flow (immediate-mode rendering pattern)
    // Viewport state for pan/zoom
    // Hashtag filter state
    // Selection box state
    // Project state (per-notebook)
    // Editor state
    // Ghost nodes (move to notebook)
    // UI state
    // Save queue state (for race condition prevention)
    // Render throttling
    // Node dimensions
    // Drag threshold for Ctrl+Drag (prevents accidental duplication on multi-select clicks)
    // Preset color palette for hashtags (works across all dark themes)
    // Autocomplete state (kept separate as it's transient UI state)
    // Constants
    // Timing (milliseconds)
    // Zoom & Viewport
    // UI Layout & Spacing
    // Animation & Interaction
    // Text Limits & Validation
    // Autocomplete
    // Z-Index Layers
    // Mobile Detection
    // This allows small desktop windows to keep desktop features
function isMobileDevice()  // line 280
        // Check if device has coarse pointer (touch) and cannot hover
        // Both conditions should be true for mobile devices
        // This avoids treating small desktop windows as mobile
        // Storage Keys
function isLocalStorageAvailable()  // line 301
function showStorageUnavailableWarning()  // line 319
        // Move to notebook constant
// ============================================================================
// THEME (line 341)
// ============================================================================
function getCurrentTheme()  // line 351
function setTheme(themeName)  // line 364
        // Validate theme exists (in case of deleted/renamed themes)
        // Remove theme from root if it's 'midnight' (default), otherwise set it
        // Update active option state
        // Save to localStorage (global default)
        // Save to current notebook if one is open
function loadSavedTheme()  // line 399
function initThemeSelector()  // line 411
        // Toggle dropdown
        // Select theme option
        // Close dropdown when clicking elsewhere
// ============================================================================
// PROJECT STORAGE (localStorage) (line 435)
// ============================================================================
function getProjectsList()  // line 446
        // Clear corrupted data and return empty list
function generateProjectId()  // line 492
function countNotes(nodes)  // line 503
function stringifyAsync(data)  // line 522
        // Use requestIdleCallback if available, otherwise fallback to immediate execution
        // Fallback for browsers without requestIdleCallback (like Safari)
        // Ensure root state is captured
        // Non-blocking JSON.stringify()
        // localStorage.setItem is synchronous, but wrap in Promise for consistency
        // Update project metadata in index
        // Success
        // Store error for UI display
        // Re-throw to allow queue to handle failure
function loadProjectFromStorage(projectId)  // line 623
        // Don't remove corrupted project data automatically - user may want to recover it
        // Just return null so app doesn't crash
        // Save empty project data
        // Remove from index if storage failed
function renameProject(projectId, newName)  // line 703
function deleteProject(projectId)  // line 719
        // Non-critical - index is already updated
        // Reset navigation
        // Load data
        // Apply notebook's theme (or use current global theme if not set)
        // Clear selection and filter
        // Update sidebar button state
        // Close sidebar
        // Check for pending move operation
function updateSaveStatus(status, error = null)  // line 818
        // Remove all status classes
        // Only remove fade-out if we're changing to a non-saved state
        // Add new status class
        // Update icon and text based on status
        // Clear any existing fade timeout to prevent flicker
        // Remove fade-out first (make visible)
        // Auto-fade after 2 seconds
        // Clear saved fade timeout when transitioning away
        // Clear saved fade timeout when transitioning away
        // Clear saved fade timeout when transitioning away
function shouldUpdateToSaved()  // line 896
function getCurrentProjectData()  // line 906
function handleSaveSuccess(savedData)  // line 923
function handleSaveFailure(error)  // line 938
function continueQueueProcessing()  // line 949
        // Guard: Already processing
        // Guard: Empty queue - update status if needed
        // Mark as in progress
function hashData(data)  // line 1000
function scheduleAutoSave()  // line 1019
        // Calculate hash of current data to detect changes
        // Skip if nothing changed since last save
        // Don't add to queue if we already have a pending save
        // The debounce will handle coalescing multiple rapid changes
        // Just reset the debounce timer
        // Add to queue (only if queue is empty)
        // Update status to pending
        // Debounce: set timer
// ============================================================================
// PROJECT LIST UI (line 1069)
// ============================================================================
function populateProjectsList()  // line 1079
        // Click on project to open
        // Click on menu button
function showProjectMenu(projectId, x, y)  // line 1148
        // Position menu
        // Adjust if menu goes off screen
function hideProjectMenu()  // line 1170
function showNewProjectModal()  // line 1179
function hideNewProjectModal()  // line 1190
function showConfirmation(message, delay = 0)  // line 1203
        // Handle delay if specified
        // Focus Yes button by default if no delay
        // Handle Yes
        // Handle No/Cancel
        // Handle keyboard
        // Cleanup function
        // Attach listeners
function showAlert(message, title = 'Alert')  // line 1292
        // Set content and show
        // Focus OK button
        // OK handler
        // Keyboard handler
        // Cleanup
        // Attach listeners
function showPrompt(message, defaultValue = '', title = 'Input Required')  // line 1342
        // Set content and show
        // Focus and select input
        // OK handler
        // Cancel handler
        // Keyboard handler
        // Cleanup
        // Attach listeners
        // Validate: max length
        // Validate: not empty
        // Validate: max length
// ============================================================================
// UTILITY FUNCTIONS (line 1478)
// ============================================================================
function generateId()  // line 1488
function parseHashtags(text)  // line 1500
        // Normalize to lowercase for consistent storage and comparison
function truncateText(text, maxLength)  // line 1515
function getNodeCenter(node)  // line 1527
function hasBodyText(node)  // line 1541
function cycleCompletion(current)  // line 1554
function nodeMatchesFilter(node)  // line 1570
        // Text search filter
        // Hashtag filter (OR logic)
        // Tags are already normalized to lowercase, so direct comparison is safe
function getVisibleNodeIds()  // line 1591
function updateSidebarButtonState()  // line 1599
function updateFilter(inputValue)  // line 1615
        // Update visual state
function clearFilter()  // line 1640
        // Also clear text search
function setFilterHashtag(hashtag)  // line 1666
function updateTextFilter(text)  // line 1678
function clearTextFilter()  // line 1699
function toggleFilterHashtag(hashtag)  // line 1715
        // Remove it
        // Add it
function toggleHiddenHashtag(hashtag)  // line 1741
        // Unhide it
        // Hide it
function showAllHashtags()  // line 1761
        // Validate new tag format
        // Validate hashtag format (must be #word with alphanumeric, underscore, or hyphen)
        // Normalize to lowercase
        // Don't rename if it's the same
        // Rename in all nodes at current level
        // Check if this node has the tag in its content (match whole hashtag)
        // Update content text (case-insensitive replacement)
        // Re-parse hashtags from updated content
        // Update filter if this tag was being filtered
        // Update the filter input to show the new tag
        // Update hidden tags if this tag was hidden
        // Transfer color to new tag name
function deleteHashtag(tag)  // line 1844
        // Remove from all nodes at current level
        // Remove from content text (case-insensitive, match whole hashtag)
        // Re-parse hashtags from updated content
        // Clear from filter if active
        // Clear from hidden tags
        // Remove color assignment
function showHashtagContextMenu(tag, x, y)  // line 1877
        // Remove existing menu if any
        // Adjust position if menu goes off screen
        // Handle menu actions
function hideHashtagContextMenu()  // line 1954
// ============================================================================
// HASHTAG SIDEBAR (line 1961)
// ============================================================================
function toggleSidebar()  // line 1971
function showSidebar()  // line 1984
function hideSidebar()  // line 1995
function closeAllColorPickers()  // line 2005
function getHashtagCounts()  // line 2017
function getHashtagColor(hashtag, autoAssign = true)  // line 2038
        // Assign a color based on hash of the hashtag name
function setHashtagColor(hashtag, color)  // line 2055
function populateSidebar()  // line 2061
        // Check which hashtags are currently active in the filter and which are hidden
        // Clear list
        // Add "Show All Tags" button (always visible, grayed out when not needed)
        // Add hashtags
        // Pill
        // Count
        // Color button
        // Hide button
        // Color picker dropdown
        // Show all tags button handler
        // Hide button handlers
        // Add click handlers for filter (pill + count only)
        // Color button handlers
        // Close other dropdowns
        // Color swatch handlers
        // Context menu handlers (right-click on hashtag row)
        // Desktop: right-click
        // Mobile: long-press (500ms)
function screenToCanvas(screenX, screenY)  // line 2247
function canvasToScreen(canvasX, canvasY)  // line 2265
function getGraphBounds(visibleOnly = false)  // line 2282
        // If visibleOnly is true, only include nodes that pass the current filters
// ============================================================================
// VIEW SWITCHING (line 2305)
// ============================================================================
function showLandingPage()  // line 2315
function showGraphView()  // line 2328
function newProject()  // line 2338
        // Show the new project modal instead of directly creating
        // Save current project before leaving
        // Force immediate save before navigation
        // Reset state
// ============================================================================
// VIEWPORT (PAN/ZOOM) (line 2378)
// ============================================================================
function updateViewport()  // line 2389
        // Calculate viewBox based on viewport state
function zoomAtPoint(delta, screenX, screenY)  // line 2412
        // Get canvas coordinates before zoom
        // Apply zoom
        // Get canvas coordinates after zoom
        // Adjust pan to keep the point under cursor stationary
function fitToView()  // line 2441
        // Use visible nodes only when filters are active
        // No nodes, reset to default view
        // Add padding around the graph
        // Calculate zoom to fit
        // Center the graph
function resetViewport()  // line 2487
// ============================================================================
// RENDERING (line 2494)
// ============================================================================
function render()  // line 2506
function renderImmediate()  // line 2522
        // Refresh sidebar if open
        // Auto-save if we have a current project (only saves if data changed)
function renderNodes()  // line 2548
        // Skip nodes that don't match filter
        // Stacked rectangles for children (rendered first so they appear behind)
        // First stack layer
        // Node body (rectangle)
        // Dog-ear fold for body text indicator (top-left corner)
        // Node title
        // Store full title for hover expansion
        // Hashtags as colored pills
        // Filter out hidden hashtags
        // Completion indicator (clickable status icon)
        // Background circle for click target
function renderEdges()  // line 2734
        // Get visible node IDs for filtering edges
        // Skip edges where either node is hidden by filter
        // Create a group to hold hitbox and visible line
        // Invisible wider hitbox for easier clicking
        // Visible edge line
function renderEdgePreview(x, y)  // line 2788
        // Remove existing preview
function clearEdgePreview()  // line 2815
function renderSelectionBox()  // line 2825
function clearSelectionBox()  // line 2854
function renderGhostNodes()  // line 2865
        // Update ghost node positions to follow cursor
        // Render each ghost node
        // Node body
        // Node title
        // Hashtags as colored pills (simplified)
function getNodesInSelectionBox(box)  // line 2954
        // Drag left-to-right: fully enclosed only
        // Drag right-to-left: fully enclosed OR intersecting
function updateBreadcrumbs()  // line 2983
// ============================================================================
// NODE OPERATIONS (line 2995)
// ============================================================================
function createNode(x, y)  // line 3007
function deepCopyNode(node, offsetX = 0, offsetY = 0)  // line 3036
        // Deep copy children recursively and create ID mapping
        // Copy child edges and remap IDs to new child IDs
function deleteNode(nodeId)  // line 3083
        // Find the node being deleted
        // Promote children to current level before deleting
        // Offset children positions relative to parent's position
        // Adjust position so children appear near where parent was
        // Promote child edges to current level
        // Remove edges connected to this node
        // Remove the node
        // Remove from selection
function selectNode(nodeId, addToSelection = false)  // line 3126
        // Toggle: add if not selected, remove if already selected
        // Replace selection with single node
function clearSelection()  // line 3147
function updateSelectionVisuals()  // line 3160
        // Update node selection visuals without full re-render
        // Update edge selection visuals
        // Update selection action bar
function updateSelectionActionBar()  // line 3191
        // Node(s) selected - show all buttons (Connect now works for batch connect)
        // Action bar is only shown on mobile via long-press
        // Edge selected - show only delete
        // On mobile, show action bar for edge deletion (hard to long-press edges)
        // Nothing selected
function showActionBar()  // line 3220
        // Trigger reflow for animation
function hideActionBar()  // line 3230
        // Hide after animation completes
function bringToFront()  // line 3248
        // Find the current max zIndex
        // Set selected nodes to maxZ + 1
function sendToBack()  // line 3268
        // Find the current min zIndex
        // Set selected nodes to minZ - 1
function getNodeContextMenuItems(selectionCount)  // line 3290
        // Multi-selection specific items
        // Common items (always available)
function createContextMenuItem(action, text)  // line 3314
function createContextMenuContainer(menuId, x, y)  // line 3331
function populateContextMenu(menu, items)  // line 3348
function adjustContextMenuPosition(menu, originalX, originalY)  // line 3364
        // Flip to left if extending beyond right edge
        // Flip to top if extending beyond bottom edge
function commandBringToFront()  // line 3382
function commandSendToBack()  // line 3390
function commandMoveTo()  // line 3398
function commandConnectTo()  // line 3406
function executeContextMenuAction(action)  // line 3416
function attachContextMenuHandler(menu, onAction)  // line 3437
function showNodeContextMenu(nodeId, x, y)  // line 3457
        // 1. Get menu configuration based on selection state
        // 2. Create menu structure
        // 3. Add to DOM (required for position adjustment)
        // 4. Adjust position to prevent off-screen rendering
        // 5. Attach event handler
function hideNodeContextMenu()  // line 3477
// ============================================================================
// EDGE OPERATIONS (line 3482)
// ============================================================================
function startEdgeCreation(nodeId)  // line 3493
        // If nodeId provided, use it; otherwise use current selection (for batch connect)
        // Batch connect mode: store all selected nodes
function completeEdgeCreation(targetNodeId)  // line 3512
        // Batch connect mode: create edges from all source nodes to target
        // Toggle edge: remove if exists, create if not
        // Single edge creation
function selectEdge(index)  // line 3557
function deleteSelectedEdge()  // line 3563
// ============================================================================
// NAVIGATION (NESTING) (line 3571)
// ============================================================================
function enterNode(nodeId)  // line 3582
        // Save current state to the node we're leaving
        // Push current node to path
        // Load children
        // Clear filter when navigating
        // Reset viewport for the new level
function goBack()  // line 3617
        // Save current state
        // Go to parent level
        // Back to root - need to restore root state
        // Clear filter when navigating
        // Reset viewport for the new level
        // Save after navigation to persist the updated tree
        // Root state storage (saved when entering first node)
function getRootNodes()  // line 3651
function getRootEdges()  // line 3655
function saveRootState()  // line 3659
// ============================================================================
// EDITOR (line 3666)
// ============================================================================
function openEditor(nodeId)  // line 3678
        // Check if we're in batch edit mode (multiple nodes selected)
        // Clear removed tags from previous session
        // Batch edit mode
        // Snapshot all nodes for cancel/revert
        // Disable title field only
        // Enable textarea for adding tags
        // Disable enter button
        // Collect all unique tags across selected nodes with counts
        // Sort by frequency (most common first), then alphabetically
        // Check completion status - if all same, show it; otherwise show mixed
        // Focus on textarea for tag entry
        // Single node edit mode
        // Snapshot current state for cancel/revert
        // Enable all fields
        // Update enter button based on whether node has children
function closeEditor()  // line 3799
function cancelEditor()  // line 3815
        // Batch mode: restore all nodes from snapshot
        // Single node mode
        // Restore node from snapshot
        // Delete empty nodes (new node that was never filled in)
        // Batch mode: apply changes to all selected nodes
        // Parse hashtags from textarea (these are tags to add)
        // Get completion state
        // Remove tags that were marked for removal
        // Add new tags to each node (avoid duplicates)
        // Set completion state (unless it's 'mixed' which means no change)
        // Single node mode
        // Validate title length (soft limit)
        // Validate content length (soft limit)
        // Save completion state
        // Delete empty nodes (created but never filled in)
function getHashtagBadgeText(tag, isBatchMode, isRemoved, tagCounts, totalNodes)  // line 3966
function applyHashtagPillStyle(element, color, isRemoved)  // line 3981
        // Outlined pill: transparent background, colored border
        // Solid pill: background color, white text
function createHashtagPill(tag, badge, color, isRemoved)  // line 4004
function saveCursorPosition(textarea)  // line 4019
function restoreCursorPosition(textarea, position)  // line 4030
function reAddRemovedTag(tag, textarea)  // line 4042
function markTagAsRemoved(tag)  // line 4054
function triggerInputWithoutAutocomplete(textarea)  // line 4065
function attachHashtagPillHandlers(display, textarea)  // line 4079
        // Abort previous listener if exists (prevents duplicates on re-render)
        // Create new AbortController for this listener
        // Create delegated handler
        // Check if clicked element is a pill
        // Return focus to textarea for better editing flow
        // Attach listener with abort signal
function cleanupHashtagPillHandlers()  // line 4121
function updateHashtagDisplay(hashtags, isBatchMode = false, totalNodes = 1, tagCounts = {})  // line 4140
        // Helper function to remove a tag from content textarea
function removeTagFromContent(tag)  // line 4158
        // Remove tag + optional trailing space, preserving leading space (unless at start)
        // Clean up multiple spaces
function updateCompletionButtons(value)  // line 4170
        // In batch mode with mixed completion states, show all buttons as inactive
// ============================================================================
// HASHTAG AUTOCOMPLETE (line 4183)
// ============================================================================
function getAutocompleteSuggestions(query)  // line 4195
function updateAutocompleteState(suggestions, inputElement)  // line 4220
function renderEmptyAutocomplete()  // line 4233
function createAutocompleteItem(suggestion, index)  // line 4248
function attachAutocompleteItemHandler(itemElement, index)  // line 4279
function populateAutocompleteList(suggestions)  // line 4292
function displayAutocompleteDropdown(inputElement)  // line 4314
function showAutocomplete(inputElement)  // line 4327
function positionAutocomplete(inputElement)  // line 4342
        // Filter input: position below the input
        // Textarea: position near caret
        // Viewport clamping
function getTextareaCaretCoords(textarea, position)  // line 4381
function hideAutocomplete()  // line 4416
function selectAutocompleteItem(index)  // line 4434
        // Assign color when user commits a tag via autocomplete selection
        // Scan forward from cursor to skip any remaining word characters
        // Set cursor after inserted text
        // Dispatch input event to trigger existing handlers
function updateAutocompleteFromInput(inputElement)  // line 4477
        // Skip if autocomplete is suppressed (synthetic event from tag pill clicks)
        // Scan backwards from cursor to find '#'
        // Check if we found a '#' at a word boundary
        // Word boundary check: '#' must be at position 0 or preceded by whitespace
        // No valid '#' found — hide
function handleAutocompleteKeydown(e)  // line 4519
        // If an item is highlighted, insert it
        // If only one suggestion remains, insert it automatically
        // Otherwise, let Enter/Tab pass through
function highlightAutocompleteItem(index)  // line 4563
        // Scroll into view
// ============================================================================
// HELP MODAL (line 4576)
// ============================================================================
function showHelp()  // line 4585
function hideHelp()  // line 4594
// ============================================================================
// MOVE TO NOTEBOOK MODAL (line 4598)
// ============================================================================
function showMoveToModal()  // line 4607
        // Get all projects except the current one
        // Populate the list
function hideMoveToModal()  // line 4647
function createNodeCopiesWithMapping(selectedNodeIds, allNodes)  // line 4659
function filterAndRemapEdges(edges, idMapping, selectedNodeIds)  // line 4678
function calculateBoundingBox(nodes)  // line 4693
function calculateRelativeOffsets(nodes, centerX, centerY)  // line 4713
function getSourceProjectName(projectId, projectsList)  // line 4731
function buildMovePackage(data)  // line 4742
function storePendingMove(movePackage)  // line 4759
        // Guard clauses - validate preconditions
        // Command execution - pure operations first, then side effects
        // 1. Data transformation
        // 2. Geometric calculations
        // 3. Data assembly
        // 4. Side effects - storage and navigation
function checkForPendingMove()  // line 4846
        // Set up ghost nodes
        // Store pending move data for later use
        // Remove from sessionStorage
        // Add ghost drag cursor
        // Show toast notification
        // Initial render with ghosts
function placeGhostNodes()  // line 4884
        // Add ghost nodes to current notebook as real nodes
        // Add edges
        // Select the newly placed nodes
        // Remove nodes from source notebook (using original IDs)
        // Show toast with link back to source notebook
        // Clear ghost state
        // Clear any selection box state
        // Remove ghost drag cursor
        // Save immediately to target notebook (don't wait for auto-save)
function cancelGhostDrag()  // line 4947
        // Store source info before clearing state
        // Remove ghost drag cursor
        // Show toast with link back to source notebook
function removeNodesRecursively(nodes, nodeIdsToRemove)  // line 4991
        // If node has children, recursively remove from children too
function removeNodesFromSourceNotebook(sourceProjectId, nodeIds)  // line 5012
        // Load source project data
        // Remove nodes by ID recursively (searches all nesting levels)
        // Remove edges that reference removed nodes
        // Save back to localStorage
        // Update note count in projects index
function showToast(message, options = {})  // line 5052
        // Toast notification with optional link
        // Always use textContent for base message
        // If a link is needed, append it programmatically
        // Enable pointer events if there's a link
        // ESC key handler to dismiss toast
        // Auto-remove after duration (default 4s, or longer if has link)
        // Override toast.remove to clean up listener
// ============================================================================
// SETTINGS MODAL (line 5124)
// ============================================================================
function showSettings(projectId)  // line 5135
        // Opened from context menu for a non-open project
        // Opened from toolbar for the current project
function hideSettings()  // line 5157
function updateSettingsToggle(toggle, isOn)  // line 5170
function toggleSettingsTask()  // line 5180
        // Update in-memory settings for the currently open project
        // Update localStorage directly for a non-open project
// ============================================================================
// FILE OPERATIONS (line 5204)
// ============================================================================
function downloadAsFile(filename, data)  // line 5215
        // Ensure root state is captured
        // Get project name for filename
        // Try File System Access API first, fall back to data URL download
        // Fallback for mobile/unsupported browsers
        // Try File System Access API first, fall back to data URL download
        // Fallback for mobile/unsupported browsers
function getFileViaInput()  // line 5359
        // Guard clause: empty file
        // Guard clause: empty content
function validateImportData(data)  // line 5399
        // Guard clauses for required fields
        // Optional fields with defaults
function updateImportModal(filename)  // line 5435
        // Update filename display
        // Show/hide overwrite button based on existing projects
        // Show modal
        // Step 1: Select file (strategy pattern)
        // Guard clause: user cancelled
        // Step 2: Read and parse
        // Step 3: Validate
        // Step 4: Store for import flow
        // Step 5: Update UI
        // Guard clause: ignore user cancellation
function hideImportModal()  // line 5487
        // Save imported data to the new project
        // Update note count
        // Save import data before hiding modal (hideImportModal clears state.pendingImportData)
        // Hide import modal and show overwrite selection modal
        // Show the selection modal and wait for user to pick a project
        // Confirm with 3-second delay
        // Save imported data to the existing project
        // Update note count
function showOverwriteSelectModal(projects)  // line 5592
        // Populate the list
        // Handle item selection
        // Handle cancel
        // Handle Escape key
        // Cleanup
        // Attach listeners
// ============================================================================
// EVENT HANDLERS (line 5659)
// ============================================================================
function initEventListeners()  // line 5663
        // Mouse down on canvas
        // Click on children indicator - enter the node
        // Click on completion indicator - cycle state
        // Click on empty space - start panning or selection box
        // Handle context menu - show node menu or prevent default for selection box
        // If we're in selection box mode, don't do anything else
        // Right-click on node - show context menu
        // Select the node if not already selected
        // Otherwise, context menu is prevented (used for selection box)
        // Mouse move
        // Update ghost cursor position if dragging ghosts
        // Pan the canvas
        // Update selection box
        // Detect initial drag direction to determine mode (only if not locked yet)
        // Check if we've exceeded the drag threshold (only for Ctrl+Drag)
        // Move all selected nodes together (whether originals or duplicates)
        // Title expansion on hover (only when not dragging/panning)
        // Clear any pending hover timeout
        // Collapse all previously expanded titles
        // Expand title after delay if hovering over node body or title
        // Mouse up
        // Place ghost nodes if in ghost dragging mode
        // Check if releasing over a node while in edge creation mode
        // Handle Ctrl+Click deselection (if no drag occurred)
        // Deselect the node that was Ctrl+clicked (it was already selected)
        // Complete selection box
        // Mouse leave - stop panning if mouse leaves canvas
        // Mouse wheel for zooming
        // Touch state for mobile
        // Helper to get distance between two touches
function getTouchDistance(touches)  // line 6057
        // Helper to get center point between two touches
function getTouchCenter(touches)  // line 6064
        // Touch start (for mobile drag and pan)
        // Close hashtag sidebar on touch (mobile UX)
        // Handle pinch zoom (2 fingers)
        // Cancel any single-touch operations
        // Touch on children indicator - enter the node immediately
        // Touch on completion indicator - cycle state
        // Touch on node - remember it, but don't drag yet
        // Start long-press timer for multi-select toggle
        // Touch on edge - select it and show action bar
        // Touch on empty space - start panning, selection box, or cancel edge mode
        // Touch move (for mobile drag and pan)
        // Update ghost cursor position if dragging ghosts
        // Handle pinch zoom
        // Zoom toward center of pinch
        // Cancel long-press if moved
        // Check if we've moved enough to count as a drag (5px threshold)
        // Update selection box if active
        // Detect drag direction for mode (enclosed vs intersecting)
        // Cancel panning if selection box started
        // Move all selected nodes together
        // Update connected edges
        // Touch end
        // Place ghost nodes if in ghost dragging mode
        // Clear touch state
        // Clear long-press timer
        // Reset pinch state
        // If there are still touches, don't reset everything
        // Complete selection box if active
        // If we didn't move, treat as a tap
        // Tap on empty space - deselect and exit tap-to-add mode
        // Full render after drag to sync everything
        // Reset touch state
        // Double click to edit
        // Keyboard shortcuts
        // Don't handle shortcuts when editing text
        // Don't handle shortcuts when a modal is open
        // Only handle shortcuts when in graph view
        // Ctrl+S - Export to file
        // N - New note
        // Enter - Edit selected node(s)
        // F - Fit to view
        // - - Zoom out
        // 0 - Reset zoom to 100%
        // C - Start connect/edge mode (from selected node, only if single selection)
        // ? - Show help
        // S - Focus text search
        // / - Open sidebar and focus hashtag filter
        // H - Toggle hashtag sidebar
        // Delete or Backspace - Delete selected
        // Escape - Save editor or clear selection (also closes modals)
        // Cancel ghost drag if active
        // Alert, prompt, and overwrite select modals handle Escape in their own handlers
        // Alt+Up Arrow - Go back in navigation
        // Ctrl+] - Bring to front
        // Ctrl+[ - Send to back
        // Spacebar - Enter pan mode
        // Spacebar keyup - Exit pan mode
        // Toolbar buttons
        // Create node in center of visible viewport
        // Close help modal when clicking outside
        // Settings modal
        // Import modal buttons
        // Move to modal buttons
        // Landing page buttons
        // Debug tools (show with Ctrl+Shift+D on landing page)
        // New project modal
        // Project menu actions
        // Close project menu when clicking outside
        // Close context menus when clicking anywhere
        // Editor buttons — Cancel (X) reverts changes, Save closes (mobile only)
        // Click outside editor content to save (only if mousedown also started on backdrop,
        // so dragging a text selection out of the editor doesn't accidentally close it)
        // Editor enter button (save then view nested notes)
        // Sync editor fields to node before navigating
        // Enter in title field saves, Escape saves
        // Textarea: autocomplete gets first chance, then Enter saves on desktop, Escape saves
        // On desktop: Enter saves (unless Shift). On mobile: Enter always inserts newline
        // Update hashtags as user types + autocomplete
        // If any removed tags are now in the content, un-remove them
        // In batch mode, show all unique tags across selected nodes
        // Count existing tags in nodes
        // Add newly typed tags (they have count 0 until saved)
        // Combine all tags
        // Sort by frequency
        // Single edit mode: show tags from content + removed tags
        // Completion buttons in editor
        // Breadcrumbs click to go back
        // Hashtag sidebar toggle
        // Close color pickers when clicking outside
        // Hashtag search input + autocomplete
        // Hashtag clear button
        // Allow Escape to blur the search input and clear filter (autocomplete gets first chance)
        // Click-outside to dismiss autocomplete
        // Blur handlers for autocomplete inputs (delayed to allow mousedown on dropdown)
        // Text search input
        // Text search clear button
        // Allow Escape to blur and clear text search
        // Selection action bar buttons
        // Create deep copies of all selected nodes
        // Copy edges where both endpoints are in the selection
        // Select the new copies
        // Close sidebar when tapping canvas on mobile
        // Save status error click - show details
        // Debug tools buttons
        // Error recovery modal buttons
// ============================================================================
// INITIALIZATION (line 7165)
// ============================================================================
function init()  // line 7175
        // Check if localStorage is available
        // Clear any stale pending move operations from browser refresh
        // Start the app when DOM is ready
        // Warn before closing if there are pending or in-progress saves
        // Block navigation if save is pending, in progress, or queued
        // Browser will show a generic warning dialog